<!--
 * Copyright (c) 2023-2024 Peraton Labs
 * SPDX-License-Identifier: Apache-2.0

 * Distribution Statement “A” (Approved for Public Release, Distribution Unlimited).
-->
# SEDIMENT on Zephyr-based Devices

Copyright (c) 2023-2024 Peraton Labs

Distribution C. Distribution authorized to U.S. Government agencies and their contractors; Administrative or Operational Use November 15 2018. Refer other requests for this document to Director, DARPA

This material is based upon work supported by the DARPA OPS-5G program under
contract number HR001120C0156. Any opinions, findings, conclusions, or
recommendations expressed here are those of the authors and do not necessarily
reflect the views of DARPA.

This document describes SEDIMENT devices implemented on top of Zephyr.

- [SEDIMENT on Zephyr-based Devices](#sediment-on-zephyr-based-devices)
  - [Prerequisite](#prerequisite)
  - [SEDIMENT Customizations](#sediment-customizations)
  - [Build](#build)
  - [Flashing](#flashing)
  - [Configurations](#configurations)
  - [Monitoring Output](#monitoring-output)
  - [Test](#test)

## Prerequisite
Follow the instructions at [Zephyr](<https://docs.zephyrproject.org/latest/getting_started/index.html>) to set up both Zephyr and its SDK.
The following description refers to zephyrproject/zephyr as $ZEPHYR and the sediment installation directory as $SEDIMENT. 

## SEDIMENT Customizations
Create in zephyr a symbolic link to the root of the sediment repository.

        $ cd $ZEPHYR
        $ ln -s $SEDIMENT .

## Build
To build a SEDIMENT app, do the following.

Change directory to zephyr

        $ cd $ZEPHYR

Set board environment variable, efm32gg_stk3701a for Giant Gecko.

        $ export BOARD=efm32gg_stk3701a

Use the following command to build sediment for Giant Gecko. The --pristine argument can be omitted for subsequent build for the same board and app. If successful, the image will be left in build/zephyr/zephyr.hex or zephyr.bin.

        $ west build sediment/apps/giant --pristine
        
If the BOARD environment variable is not set, add `-b <BOARD>` to the command

        $ west build -b efm32gg_stk3701a sediment/apps/giant --pristine
        
The build will fail because of configuration errors. Copy the correct configurations as follows (replace giant with stm for STM32F767ZI).

        $ cp $SEDIMENT/apps/giant/doc/dot.config build/zephyr/.config

Rebuild without the --pristine option

        $ west build -b efm32gg_stk3701a sediment/apps/giant

## Flashing
To install SEDIMENT on a device, do the following.

1.  Change directory to zephyr

        $ cd $ZEPHYR
        
2. Connect the Giant Gecko to the host computer using USB and run the command below

        $ west flash

Once the flashing is completed, the device will reset and start running. Note that, for Giant Gecko, SEGGER J-Link needs to be installed on the host. If not, download it from [J-Link](https://www.segger.com/downloads/jlink/) and follow the [instructions](https://eclipse-embed-cdt.github.io/debug/jlink/install/) to install. 


## Configurations
Device configurations are done using the provisioner app, which is built together with other SEDIMENT executables. The provisioner's
PROVISION mode is used to write a configuration file to the flash of an IoT device. The configuration file is usually generated by this program in the GEN mode. 

The provisioner runs as a server and the device being provisioned as a client, which requires that a copy of the SEDIMENT firmware is already running on the device.

    # Connect the device to the host via USB.
    # Open a serial communication tool, e.g. gtkterm, and select the apprpriate port, e.g. /dev/ttyACM0.
    # Start the provisioner program on the host.
        $ provisioner -m PROVISION -p <config file> -d /tmp/sediment/sediment.db
    # From gtkterm, enter the following command
        $ sediment provision 192.168.0.131 8888
    where 192.168.0.131 is the IP address of the host where the provisioner is running and 8888 (default) is the port.

At this point, the process should start and a few messages will be displayed in the terminal and gtkterm, indicating which flash pages have been provisioned. The entire process should take about 5 seconds. 

To slightly automate the above process, you can use the python utility $SEDIMENT/util/provision.py after connecting the device to the host.

    python3 provision.py -m provision -c /tmp/sediment/Nordic-001 -a 192.168.0.131

There is no need for a serial communication tool if you choose to do it this way.

You can also use provision.py to read back the configurations on the device.

    python3 provision.py -m read

## Monitoring Output
Use a serial terminal, e.g. minicom on Linux or putty on Windows, to monitor the messages with the following settings:

        Speed: 115200
        Data: 8 bits
        Parity: None
        Stop bits: 1

On Linux, do the following, assuming the deivce is detected at /dev/ttyACM0.

        $ minicom -D /dev/ttyACM0 

## Test
Review Test Configuration in SEDIMENT-Guide to see how to set up the servers and test it together with the device.
